**Private Service Connect (PSC)** を採用することで、VPC ピアリング（Private Service Access）の制約から解放され、IPアドレス設計が劇的にシンプルかつセキュアになります。

公式ドキュメントおよびベストプラクティスに基づき、GKE と Cloud SQL (または AlloyDB) を PSC で接続するための**最適なネットワークリソース設定**を以下に提案します。

### 推奨ネットワーク構成：PSC ベース

PSC 構成における最大の違いは、**データベース接続用に大きな CIDR ブロック（例: `/20`）を予約する必要がなく、たった「1つの内部 IP アドレス」があれば良い**という点です。

#### 1. 作成すべきリソース一覧

| リソース                     | 設定値の例 (推奨)                                                  | 役割・理由                                                                                         |
| :--------------------------- | :----------------------------------------------------------------- | :------------------------------------------------------------------------------------------------- |
| **VPC ネットワーク**         | `vpc-artist-app` (カスタムモード)                                  | プロジェクト全体を収容するネットワーク基盤。                                                       |
| **サブネット (GKE用)**       | `subnet-gke-tokyo`<br>CIDR: `10.10.0.0/20`                         | GKE ノード、Pod、Service 用。この中に PSC エンドポイントの IP も配置可能です。                     |
| **PSC エンドポイント IP**    | `10.10.0.5` (上記サブネット内の静的IP)                             | **ここが重要です。** DB インスタンスそのものではなく、VPC 内に置く「接続窓口」の IP アドレスです。 |
| **Cloud DNS**                | プライベートゾーン: `db.internal`<br>Aレコード: `sql -> 10.10.0.5` | アプリが `sql.db.internal` という名前で DB にアクセスできるようにします。                          |
| **Cloud NAT**                | リージョン: `asia-northeast1`                                      | GKE から外部（クローリング対象サイト）へのアクセス用。                                             |
| **限定公開のGoogleアクセス** | `ON` (サブネット設定)                                              | Vertex AI API 等へのアクセス用。Cloud NAT を経由せず内部ネットワークで通信します。                 |

---

### 2. 具体的な設定ステップ

以前の構成案（PSA/VPCピアリング）とは手順が異なります。特にデータベース作成と接続の順序に注意してください。

#### ステップ 1: VPC とサブネットの作成

VPC ピアリング用の「IP 範囲の予約」は**不要**になりました。GKE 用のサブネットを作成し、**限定公開の Google アクセス**をオンにします。

#### ステップ 2: Cloud NAT の設定

クローラーが外部のアーティスト公式サイトにアクセスできるよう、Cloud NAT を設定します。

- **対象:** GKE サブネットのプライマリ IP 範囲およびセカンダリ IP 範囲。

#### ステップ 3: Cloud SQL (AlloyDB) インスタンスの作成

データベース作成時に **Private Service Connect (PSC)** を有効にします。

- **設定箇所:** 接続設定で「Private Service Connect」を選択。
- **許可するプロジェクト:** 自分のプロジェクト ID を指定します。
- **結果:** 作成完了後、データベース側から「サービス アタッチメント URI」が発行されます（例: `projects/.../regions/.../serviceAttachments/...`）。

#### ステップ 4: PSC エンドポイント（転送ルール）の作成

自分の VPC 内に、DB への入り口（エンドポイント）を作ります。

1.  「Private Service Connect」管理画面へ移動。
2.  「接続エンドポイント」を作成。
3.  **ターゲット:** ステップ 3 で取得した「サービス アタッチメント URI」を入力。
4.  **IP アドレス:** GKE サブネット内の未割り当て IP アドレスを 1 つ指定して予約（例: `10.10.0.5`）。

#### ステップ 5: Cloud DNS の設定

アプリケーション（GKE 上の Pod）が接続しやすいように、IP アドレスに名前を付けます。

1.  **Cloud DNS** で「限定公開ゾーン（Private Zone）」を作成。
    - ゾーン名: `private-db-zone` (任意)
    - DNS 名: `db.internal` (任意)
    - ネットワーク: 作成した VPC を選択。
2.  **レコードセットを追加**。
    - DNS 名: `sql.db.internal`
    - タイプ: `A`
    - IP アドレス: ステップ 4 で作成した PSC エンドポイントの IP (`10.10.0.5`)。

### 3. アプリケーション（GKE）からの接続方法

アプリケーションの設定ファイル（Kubernetes Manifest や環境変数）では、以下のように指定します。

- **DB ホスト:** `sql.db.internal` (または IP `10.10.0.5`)
- **DB ポート:** `5432` (PostgreSQLの場合)

これで、アプリケーションは VPC 内のプライベート IP 経由で、安全かつ高速にデータベースへアクセスできます。Cloud SQL Auth Proxy サイドカーは必須ではありませんが、IAM 認証などを行いたい場合は PSC 経由でも併用可能です。

### この構成のメリット（更新版）

1.  **IPアドレスの超節約:**
    以前の構成ではデータベース接続のために `/20` (約4,000 IP) を予約する必要がありましたが、今回は **たった 1 つの IP アドレス** で済みます。GKE の IP 消費が激しいため、これは大きなメリットです。
2.  **一方向の接続:**
    PSC は「コンシューマ（GKE）」から「プロデューサー（DB）」への一方向通信です。データベース側のネットワークから GKE 側に侵入されるリスクがなく、セキュリティが向上します。
3.  **Vertex AI Vector Search との親和性:**
    Vertex AI Vector Search のインデックス エンドポイントも PSC での接続が推奨されています,。将来的に RAG を実装する際、DB と同じネットワーク設計思想（PSC エンドポイント経由）で統一できます。
